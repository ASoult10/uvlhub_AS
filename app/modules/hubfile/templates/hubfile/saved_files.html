{% extends "base_template.html" %}

{% block title %}Saved Models{% endblock %}

{% block content %}
<div class="container mt-4">

    <h1 class="text-center mb-4">Saved Models</h1>

    {% if files_data %}
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Title</th>
                <th>Dataset</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for file in files_data %}
            <tr>
                <td>{{ file.name }}</td>
                <td>{{ file.dataset_title }}</td>
                <td>
                    <button onclick="viewFile('{{ file.id }}')" 
                            class="btn btn-outline-secondary btn-sm" 
                            style="border-radius: 5px;">
                        <i data-feather="eye"></i> View
                    </button>

                    <button id="save-btn-{{ file.id }}"
                            onclick="saveInCart('{{ file.id }}')"
                            class="btn btn-sm {{ 'btn-secondary' if file.saved else 'btn-outline-secondary' }}"
                            style="border-radius: 5px;">
                        <i data-feather="bookmark"></i>
                        <span>{{ 'Saved' if file.saved else 'Save' }}</span>
                    </button>

                    <div class="btn-group" role="group">
                        <button id="btnGroupDrop{{ file.id }}" type="button" 
                                class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                data-bs-toggle="dropdown" aria-expanded="false" 
                                style="border-radius: 5px;">
                            <i data-feather="check"></i> Check
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="btnGroupDrop{{ file.id }}">
                            <li><a class="dropdown-item" href="javascript:void(0);" onclick="checkJSON('{{ file.id }}')">Syntax check</a></li>
                        </ul>
                    </div>

                    <a href="{{ url_for('hubfile.download_file', file_id=file.id) }}" 
                       class="btn btn-primary btn-sm" 
                       style="border-radius: 5px;"
                       download>
                        <i data-feather="download"></i> Export JSON
                    </a>

                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Botón global Export All en JSON -->
    <div class="text-end mt-3">
        <a href="{{ url_for('hubfile.download_all_saved', export_format='uvl') }}" 
           class="btn btn-primary"
           download>
            <i data-feather="download"></i> Export All as JSON
        </a>
    </div>

    {% else %}
    <div class="alert alert-info text-center">
        You have no saved files.
    </div>
    {% endif %}

</div>

<!-- Modal para visualizar archivos -->
<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileViewerModalLabel">File Viewer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: 70vh;">
                <pre id="fileContent" style="height: 100%; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; background-color: #f5f5f5; padding: 20px; border-radius: 5px; border: 1px solid #ccc;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    feather.replace();
});

var currentFileId;

function saveInCart(fileId) {
    const btn = document.getElementById(`save-btn-${fileId}`);
    const textNode = btn.querySelector('span');

    const isSaved = btn.classList.contains('btn-secondary');
    const url = isSaved ? `/file/unsave/${fileId}` : `/file/save/${fileId}`;

    const previousText = textNode ? textNode.textContent : '';
    const previousClasses = btn.className;

    btn.disabled = true;
    if (textNode) textNode.textContent = isSaved ? 'Removing...' : 'Saving...';

    fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text().then(text => ({ response, text })))
        .then(({ response, text }) => {
            // If backend redirected to login page or returned unauthorized, show a friendly message
            if (response.status === 401 || response.status === 302) {
                throw new Error('Debes iniciar sesión para guardar archivos');
            }

            if (!response.ok) {
                // Try to parse a JSON error body, but never show raw HTML to users
                try {
                    const json = text ? JSON.parse(text) : null;
                    const msg = (json && (json.error || json.message)) || response.statusText || `HTTP ${response.status}`;
                    throw new Error(msg);
                } catch (_) {
                    throw new Error(response.statusText || `HTTP ${response.status}`);
                }
            }

            let parsedData = null;
            if (text) {
                try { parsedData = JSON.parse(text); }
                catch (_) { parsedData = null; }
            }

            if (parsedData && ((parsedData.success === false) || parsedData.error)) {
                const err = parsedData.error || 'Operación no permitida';
                if (err === 'not_authenticated') throw new Error('Debes iniciar sesión para guardar archivos');
                throw new Error(err);
            }

            if (isSaved) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-outline-secondary');
                if (textNode) textNode.textContent = 'Save';
            } else {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-secondary');
                if (textNode) textNode.textContent = 'Saved';
            }
        })
        .catch(error => {
            console.error('Error al guardar/quitar archivo:', error);
            btn.className = previousClasses;
            if (textNode) textNode.textContent = previousText;
            alert(error.message || 'Error al guardar. Inténtalo de nuevo.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.classList.remove('opacity-75');
            btn.removeAttribute('aria-busy');
        });
}

function viewFile(fileId) {
    fetch(`/file/view/${fileId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('fileContent').textContent = data.content;
            currentFileId = fileId;
            var modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error al cargar el archivo:', error);
            alert('Error al cargar el archivo');
        });
}

// Note: UVL-based syntax checking was replaced by JSON validation.

function checkJSON(fileId) {
    fetch(`/file/check_json/${fileId}`)
        .then(response => response.json().then(body => ({ status: response.status, body })))
        .then(({ status, body }) => {
            if (status === 200 && body.valid) {
                alert('✓ JSON is valid and structure matches expected schema');
            } else if (status === 400) {
                const errs = body.errors || body.body || JSON.stringify(body);
                alert('✗ JSON errors found:\n\n' + (Array.isArray(errs) ? errs.join('\n') : errs));
            } else {
                alert('Error validating JSON: ' + (body.error || JSON.stringify(body)));
            }
        })
        .catch(error => {
            console.error('Error checking JSON:', error);
            alert('Error checking JSON');
        });
}
</script>
{% endblock %}