{% extends "base_template.html" %}

{% block title %}View dataset{% endblock %}

{% block head_extra %}
<style>
    .option-button {
        display: block;
        width: 100%;
        margin-bottom: 5px;
    }
    .option-button:last-child { margin-bottom: 0; }

    /* --- Comments UI --- */
    .comment-item {
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 12px;
        background: #fff;
    }
    .comment-item .meta { font-size: 0.9rem; color: #6c757d; }

    .comment-skeleton {
        height: 64px;
        border-radius: 6px;
        background: linear-gradient(90deg, #f2f2f2 25%, #e9e9e9 37%, #f2f2f2 63%);
        background-size: 400% 100%;
        animation: shimmer 1.4s ease infinite;
    }
    @keyframes shimmer { 0% { background-position: 100% 0; } 100% { background-position: 0 0; } }

    .comment-actions .btn { padding: 2px 8px; }
    .comment-empty { color: #6c757d; font-style: italic; }
</style>
{% endblock %}

{% block content %}

<div class="row mb-3">
    <div class="col-6">
        <a href="/explore" class="btn btn-primary btn-sm" id="search" style="border-radius: 5px;">
            <i data-feather="search" class="center-button-icon"></i>
            Explore more datasets
        </a>
    </div>
</div>

<div class="row">
    <div class="col-xl-8 col-lg-12 col-md-12 col-sm-12">

        <!-- ==== DATASET INFO ==== -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h1><b>{{ dataset.ds_meta_data.title }}</b></h1>
                    <div><span class="badge bg-secondary">{{ dataset.get_cleaned_publication_type() }}</span></div>
                </div>
                <p class="text-secondary">{{ dataset.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>

                <div class="row mb-4">
                    <div class="col-md-4 col-12"><span class=" text-secondary">Description</span></div>
                    <div class="col-md-8 col-12"><p class="card-text">{{ dataset.ds_meta_data.description }}</p></div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-4 col-12"><span class=" text-secondary">Uploaded by</span></div>
                    <div class="col-md-8 col-12"><a href="#">{{ dataset.user.profile.surname }}, {{ dataset.user.profile.name }}</a></div>
                </div>

                <div class="row mb-2">
                    <div class="col-md-4 col-12"><span class=" text-secondary">Authors</span></div>
                    <div class="col-md-8 col-12">
                        {% for author in dataset.ds_meta_data.authors %}
                        <p class="p-0 m-0">
                            {{ author.name }}
                            {% if author.affiliation %} ({{ author.affiliation }}){% endif %}
                            {% if author.orcid %} ({{ author.orcid }}){% endif %}
                        </p>
                        {% endfor %}
                    </div>
                </div>

                {% if dataset.ds_meta_data.publication_doi %}
                <div class="row mb-2">
                    <div class="col-md-4 col-12"><span class="text-secondary">Publication DOI</span></div>
                    <div class="col-md-8 col-12">
                        <a href="{{ dataset.ds_meta_data.publication_doi }}">{{ dataset.ds_meta_data.publication_doi }}</a>
                    </div>
                </div>
                {% endif %}

                {% if dataset.ds_meta_data.dataset_doi %}
                <div class="row mb-2">
                    <div class="col-md-4 col-12"><span class=" text-secondary">Zenodo record</span></div>
                    {% if FLASK_ENV == 'production' %}
                    <div class="col-md-8 col-12">
                        <a href="https://zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}" target="_blank">
                            https://zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}
                        </a>
                    </div>
                    {% elif FLASK_ENV == 'development' %}
                    <div class="col-md-8 col-12">
                        <a href="https://sandbox.zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}" target="_blank">
                            https://sandbox.zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}
                        </a>
                    </div>
                    {% else %}
                    <div class="col-md-8 col-12">
                        <a href="https://zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}" target="_blank">
                            https://zenodo.org/records/{{ dataset.ds_meta_data.deposition_id }}
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="row mb-2">
                    <div class="col-md-4 col-12"><span class=" text-secondary">Tags</span></div>
                    <div class="col-md-8 col-12">
                        {% if dataset.ds_meta_data.tags %}
                            {% for tag in dataset.ds_meta_data.tags.split(',') %}
                            <span class="badge bg-secondary">{{ tag.strip() }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted">No tags</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if dataset.ds_meta_data.dataset_doi %}
            <div class="card-body" style="padding-top: 0px">
                <div id="dataset_doi_uvlhub" style="display: none">{{ dataset.get_uvlhub_doi() }}</div>
                <button type="button" class="btn doi_button btn-sm" onclick="copyText('dataset_doi_uvlhub')">
                    <span class="button_doi_id">
                        <i data-feather="clipboard" class="center-button-icon" style="cursor: pointer"></i>
                        <b>DOI</b>
                    </span>
                    <span class="doi_text">{{ dataset.get_uvlhub_doi() }}</span>
                </button>
            </div>
            {% endif %}
        </div>

        <!-- ==== OBSERVATIONS ==== -->
        <div class="card mt-3">
            <div class="card-body">
                <h3 class="mb-3">Observations</h3>

                {% if not dataset.ds_meta_data.observations or dataset.ds_meta_data.observations|length == 0 %}
                    <p class="text-muted mb-0">No observations associated with this dataset.</p>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Object name</th>
                                    <th>RA</th>
                                    <th>DEC</th>
                                    <th>Mag</th>
                                    <th>Date</th>
                                    <th>Filter</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for obs in dataset.ds_meta_data.observations %}
                                <tr>
                                    <td>{{ obs.object_name }}</td>
                                    <td>{{ obs.ra }}</td>
                                    <td>{{ obs.dec }}</td>
                                    <td>
                                        {% if obs.magnitude is not none %}
                                            {{ obs.magnitude }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if obs.observation_date %}
                                            {{ obs.observation_date.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td>{{ obs.filter_used or '—' }}</td>
                                    <td style="max-width: 250px; white-space: pre-wrap; word-break: break-word;">
                                        {{ obs.notes or '' }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- ==== RELATED PUBLICATION ==== -->
        <div class="card mt-3">
            <div class="card-body">
                <h3> Related publication </h3>
                David Romero-Organvidez, José A. Galindo, Chico Sundermann, Jose-Miguel Horcas, David Benavides,
                <i>UVLHub: A feature model data repository using UVL and open science principles</i>,
                Journal of Systems and Software, 2024, 112150, ISSN 0164-1212,
                <a href="https://doi.org/10.1016/j.jss.2024.112150" target="_blank">https://doi.org/10.1016/j.jss.2024.112150</a>
            </div>

            <div class="card-body mt-0 pt-0">
                <button onclick="copyText('bibtex_cite')" class="btn btn-light btn-sm" style="border-radius: 5px; margin-right: 10px"><i data-feather="clipboard" class="center-button-icon"></i> Copy in BibTex</button>
                <button onclick="copyText('ris_cite')" class="btn btn-light btn-sm" style="border-radius: 5px;"><i data-feather="clipboard" class="center-button-icon"></i> Copy in RIS</button>
                <button onclick="copyText('apa_cite')" class="btn btn-light btn-sm" style="border-radius: 5px;"><i data-feather="clipboard" class="center-button-icon"></i> Copy in APA</button>
                <button onclick="copyText('text_cite')" class="btn btn-light btn-sm" style="border-radius: 5px;"><i data-feather="clipboard" class="center-button-icon"></i> Copy in text</button>
            </div>
        </div>

        <!-- ====== COMMENTS CARD ====== -->
        <div class="card mt-3">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <h3 class="mb-0">Comments</h3>
                    <span class="text-muted small">Share feedback, ask questions, or suggest improvements</span>
                </div>

                <hr>

                {% if current_user.is_authenticated %}
                <form id="commentForm" onsubmit="return submitDatasetComment(event)">
                    <div class="mb-2">
                        <label for="commentContent" class="form-label">Write a comment</label>
                        <textarea id="commentContent" class="form-control" rows="3" maxlength="2000" placeholder="Be respectful and stay on topic." required></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Max 2000 characters</small>
                        <button id="commentSendBtn" type="submit" class="btn btn-primary btn-sm" style="border-radius: 5px;">
                            <i data-feather="send" class="center-button-icon"></i> Post comment
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i data-feather="info" class="me-2"></i>
                    <div>Please sign in to comment.</div>
                </div>
                {% endif %}

                <hr>

                <div class="d-flex align-items-center mb-2">
                    <i data-feather="message-circle" class="me-2"></i>
                    <h5 class="mb-0">All comments</h5>
                </div>

                <!-- Skeleton FUERA de commentsList para no borrarlo al renderizar -->
                <div id="commentsSkeleton" class="vstack gap-2 d-none">
                    <div class="comment-skeleton"></div>
                    <div class="comment-skeleton"></div>
                    <div class="comment-skeleton"></div>
                </div>

                <!-- Contenedor de comentarios -->
                <div id="commentsList" class="vstack gap-2"></div>

                <div id="commentsError" class="alert alert-danger d-none mt-3" role="alert"></div>
                <div id="commentsEmpty" class="comment-empty d-none">No comments yet. Be the first!</div>
            </div>
        </div>
        <!-- ====== /COMMENTS CARD ====== -->

    </div>

    <!-- ==== RIGHT COLUMN ==== -->
    <div class="col-xl-4 col-lg-12 col-md-12 col-sm-12">
        <div class="list-group">
            <div class="list-group-item">
                <div class="row">
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <h4 style="margin-bottom: 0px">UVL models</h4>
                        <h4 style="margin-bottom: 0px;"><span class="badge bg-dark">{{ dataset.get_files_count() }}</span></h4>
                    </div>
                </div>
            </div>

            {% for feature_model in dataset.feature_models %}
                {% for file in feature_model.files %}
                <div class="list-group-item">
                    <div class="row">
                        <div class="col-12">
                            <div class="row">
                                <div class="col-8">
                                    <i data-feather="file"></i> {{ file.name }}
                                    <br><small class="text-muted">({{ file.get_formatted_size() }})</small>
                                </div>
                                <div class="col-2">
                                    <div id="check_{{ file.id }}"></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 text-end">
                            <button onclick="viewFile('{{ file.id }}')" class="btn btn-outline-secondary btn-sm" style="border-radius: 5px;">
                                <i data-feather="eye"></i> View
                            </button>

                            {% set saved = hubfile_service.is_saved_by_user(file.id, current_user.id) %}
                            <button id="save-btn-{{ file.id }}"
                                    onclick="saveInCart('{{ file.id }}')"
                                    class="btn btn-sm {{ 'btn-secondary' if saved else 'btn-outline-secondary' }}"
                                    style="border-radius: 5px;">
                                <i data-feather="bookmark"></i>
                                <span>{{ 'Saved' if saved else 'Save' }}</span>
                            </button>

                            <div class="btn-group" role="group">
                                <button id="btnGroupDrop{{ file.id }}" type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style=" border-radius: 5px;">
                                    <i data-feather="check"></i> Check
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="btnGroupDrop{{ file.id }}">
                                    <li>
                                        <a class="dropdown-item" href="javascript:void(0);" onclick="checkUVL('{{ file.id }}')">
                                            Syntax check
                                        </a>
                                    </li>
                                </ul>
                            </div>

                            <div class="btn-group" role="group">
                                <button id="btnGroupDropExport{{ file.id }}" type="button" class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style=" border-radius: 5px;">
                                    <i data-feather="download"></i> Export
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="btnGroupDropExport{{ file.id }}">
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('hubfile.download_file', file_id=file.id) }}">UVL</a>
                                        <a class="dropdown-item" href="{{ url_for('flamapy.to_glencoe', file_id=file.id) }}">Glencoe</a>
                                    </li>
                                    <li><a class="dropdown-item" href="{{ url_for('flamapy.to_cnf', file_id=file.id) }}">DIMACS</a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('flamapy.to_splot', file_id=file.id) }}">SPLOT</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endfor %}
        </div>

        <!-- Recommended Datasets Section -->
        {% if recommendations and recommendations|length > 0 %}
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">
                    <i data-feather="star"></i> Recommended Datasets
                </h5>
                <p class="text-muted mb-3" style="font-size: 0.9rem;">Based on similar tags and authors</p>

                {% for rec in recommendations %}
                <div class="mb-2">
                    <a href="/doi/{{ rec.dataset.ds_meta_data.dataset_doi }}/" class="text-decoration-none">
                        <div class="recommendation-card p-2 rounded" style="background-color: #f8f9fa; border-left: 3px solid #5700b3;">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong style="color: #5700b3; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px;">
                                    {% if rec.dataset.ds_meta_data.title|length > 40 %}
                                        {{ rec.dataset.ds_meta_data.title[:40] }}...
                                    {% else %}
                                        {{ rec.dataset.ds_meta_data.title }}
                                    {% endif %}
                                </strong>
                                <span class="badge" style="background-color: #5700b3; font-size: 0.85rem; white-space: nowrap;">
                                    {{ rec.score }}/10
                                </span>
                            </div>
                            <small class="text-muted" style="font-size: 0.85rem;">
                                {{ rec.downloads }} downloads · {{ rec.coincidences }} match{{ 'es' if rec.coincidences != 1 else '' }}
                            </small>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <a href="/dataset/download/{{ dataset.id }}" class="btn btn-primary mt-3" style="border-radius: 5px;">
            <i data-feather="download" class="center-button-icon"></i>
            Download all ({{ dataset.get_file_total_size_for_human() }})
        </a>
    </div>
</div>

<!-- Modal-->
<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="height: 80vh; display: flex; align-items: center;">
        <div class="modal-content" style="height: 80vh;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title" id="fileViewerModalLabel">Feature model view</h5>
                <div>
                    <a href="#" class="btn btn-outline-primary btn-sm" id="downloadButton" style="margin-right: 5px; margin-bottom: 5px; border-radius: 5px;">
                        <i data-feather="download"></i>
                    </a>
                    <button onclick="copyToClipboard()" class="btn btn-outline-secondary btn-sm" style="margin-right: 5px; margin-bottom: 5px; border-radius: 5px;">
                        <i data-feather="copy"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body" style="overflow-y: auto; height: calc(100vh - 50px);">
                <pre id="fileContent" style="height: 100%; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; background-color: #f5f5f5; padding: 20px; border-radius: 5px; border: 1px solid #ccc;"></pre>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    feather.replace();
    // Comments bootstrap on page load
    loadDatasetComments();
});

var currentFileId;

function saveInCart(fileId) {
    const btn = document.getElementById(`save-btn-${fileId}`);
    const textNode = btn.querySelector('span');

    const isSaved = btn.classList.contains('btn-secondary');
    const url = isSaved ? `/file/unsave/${fileId}` : `/file/save/${fileId}`;

    const previousText = textNode ? textNode.textContent : '';
    const previousClasses = btn.className;

    btn.disabled = true;
    if (textNode) textNode.textContent = isSaved ? 'Removing...' : 'Saving...';

    fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text().then(text => ({ response, text })))
        .then(({ response, text }) => {
            if (!response.ok) {
                const msg = text || response.statusText || `HTTP ${response.status}`;
                throw new Error(msg);
            }

            let parsedData = null;
            if (text) {
                try { parsedData = JSON.parse(text); }
                catch (_) {}
            }

            if (parsedData && ((parsedData.success === false) || parsedData.error)) {
                const err = parsedData.error || 'Operación no permitida';
                if (err === 'not_authenticated') throw new Error('Debes iniciar sesión para guardar archivos');
                throw new Error(err);
            }

            if (isSaved) {
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-outline-secondary');
                if (textNode) textNode.textContent = 'Save';
            } else {
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-secondary');
                if (textNode) textNode.textContent = 'Saved';
            }
        })
        .catch(error => {
            console.error('Error al guardar/quitar archivo:', error);
            btn.className = previousClasses;
            if (textNode) textNode.textContent = previousText;
            alert(error.message || 'Error al guardar. Inténtalo de nuevo.');
        })
        .finally(() => {
            btn.disabled = false;
            btn.classList.remove('opacity-75');
            btn.removeAttribute('aria-busy');
        });
}

function viewFile(fileId) {
    fetch(`/file/view/${fileId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('fileContent').textContent = data.content;
            currentFileId = fileId;
            document.getElementById('downloadButton').href = `/file/download/${fileId}`;
            var modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
            modal.show();
        })
        .catch(error => console.error('Error loading file:', error));
}

function showLoading() { document.getElementById("loading").style.display = "initial"; }
function hideLoading() { document.getElementById("loading").style.display = "none"; }

function checkUVL(file_id) {
    const outputDiv = document.getElementById('check_' + file_id);
    outputDiv.innerHTML = '';

    fetch(`/flamapy/check_uvl/${file_id}`)
        .then(response => {
            return response.json().then(data => ({ status: response.status, data }));
        })
        .then(({ status, data }) => {
            if (status === 400) {
                if (data.errors) {
                    outputDiv.innerHTML = '<span class="badge badge-danger">Errors:</span>';
                    data.errors.forEach(error => {
                        const e = document.createElement('span');
                        e.className = 'badge badge-danger';
                        e.textContent = error;
                        outputDiv.appendChild(e);
                        outputDiv.appendChild(document.createElement('br'));
                    });
                } else {
                    outputDiv.innerHTML = `<span class="badge badge-danger">Error: ${data.error}</span>`;
                }
            } else if (status === 200) {
                outputDiv.innerHTML = '<span class="badge badge-success">Valid Model</span>';
            } else {
                outputDiv.innerHTML = `<span class="badge badge-warning">Unexpected response status: ${status}</span>`;
            }
        })
        .catch(error => {
            outputDiv.innerHTML = `<span class="badge badge-danger">An unexpected error occurred: ${error.message}</span>`;
        });
}

function copyToClipboard() {
    const text = document.getElementById('fileContent').textContent;
    navigator.clipboard.writeText(text).catch(err => console.error('Failed to copy text: ', err));
}

// ===========================
// Comments: frontend logic
// ===========================
const DATASET_ID  = JSON.parse('{{ dataset.id | tojson | safe }}');
const IS_AUTH     = JSON.parse('{{ current_user.is_authenticated | tojson | safe }}');
const CAN_MODERATE = JSON.parse('{{ (current_user.is_authenticated and (current_user.id == dataset.user_id or (current_user.is_admin is defined and current_user.is_admin))) | tojson | safe }}');

function toggle(el, show) { if (!el) return; el.classList[show ? 'remove' : 'add']('d-none'); }

function loadDatasetComments() {
    const list = document.getElementById('commentsList');
    const skel = document.getElementById('commentsSkeleton');
    const empty = document.getElementById('commentsEmpty');
    const err = document.getElementById('commentsError');

    toggle(err, false);
    toggle(empty, false);
    if (skel) toggle(skel, true);
    if (list) list.innerHTML = '';

    fetch(`/dataset/{{ dataset.id }}/comments/`)
        .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
        .then(comments => {
            if (skel) toggle(skel, false);
            renderComments(comments);
        })
        .catch(e => {
            if (skel) toggle(skel, false);
            err.textContent = `Could not load comments: ${e.message}`;
            toggle(err, true);
        });
}

function renderComments(comments) {
    const list = document.getElementById('commentsList');
    const empty = document.getElementById('commentsEmpty');

    if (!comments || comments.length === 0) {
        if (list) list.innerHTML = '';
        toggle(empty, true);
        feather.replace();
        return;
    }

    if (list) list.innerHTML = '';

    comments.forEach(c => {
        const item = document.createElement('div');
        item.className = 'comment-item';

        const top = document.createElement('div');
        top.className = 'd-flex justify-content-between align-items-start';

        const left = document.createElement('div');
        left.className = 'd-flex align-items-center';

        const icon = document.createElement('i');
        icon.setAttribute('data-feather', 'user');
        icon.classList.add('me-2');

        const meta = document.createElement('div');
        meta.className = 'meta';
        const d = new Date((c.created_at || 0) * 1000);
        meta.textContent = `User #${c.author_id} • ${d.toLocaleString()}`;

        left.appendChild(icon);
        left.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'comment-actions';
        if (CAN_MODERATE) {
            const hideBtn = document.createElement('button');
            hideBtn.className = 'btn btn-outline-secondary btn-sm me-1';
            hideBtn.innerHTML = '<i data-feather="eye-off"></i>';
            hideBtn.title = 'Hide comment';
            hideBtn.onclick = () => moderateDatasetComment(c.id, 'hide');

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn-outline-danger btn-sm';
            delBtn.innerHTML = '<i data-feather="trash-2"></i>';
            delBtn.title = 'Delete comment';
            delBtn.onclick = () => { if (confirm('Delete this comment?')) { moderateDatasetComment(c.id, 'delete'); } };

            actions.appendChild(hideBtn);
            actions.appendChild(delBtn);
        }

        top.appendChild(left);
        top.appendChild(actions);

        const body = document.createElement('div');
        body.className = 'mt-2';
        const p = document.createElement('p');
        p.className = 'mb-0';
        p.textContent = c.content || '';
        body.appendChild(p);

        item.appendChild(top);
        item.appendChild(body);

        if (list) list.appendChild(item);
    });

    feather.replace();
}

function submitDatasetComment(ev) {
    ev.preventDefault();
    const textarea = document.getElementById('commentContent');
    const btn = document.getElementById('commentSendBtn');
    const err = document.getElementById('commentsError');

    toggle(err, false);

    const content = (textarea.value || '').trim();
    if (!content) { return false; }

    btn.disabled = true;

    fetch(`/dataset/{{ dataset.id }}/comments/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content })
    })
    .then(async r => {
        const data = await r.json().catch(() => ({}));
        if (r.status !== 201) {
            const msg = data && data.error ? data.error : `HTTP ${r.status}`;
            throw new Error(msg);
        }
        return data;
    })
    .then(_ => {
        textarea.value = '';
        loadDatasetComments();
    })
    .catch(e => {
        err.textContent = `Could not post comment: ${e.message}`;
        toggle(err, true);
    })
    .finally(() => { btn.disabled = false; });

    return false;
}

function moderateDatasetComment(commentId, action) {
    const err = document.getElementById('commentsError');
    toggle(err, false);

    fetch(`/dataset/{{ dataset.id }}/comments/${commentId}/moderate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action })
    })
    .then(async r => {
        const data = await r.json().catch(() => ({}));
        if (!r.ok) {
            const msg = data && data.error ? data.error : `HTTP ${r.status}`;
            throw new Error(msg);
        }
        loadDatasetComments();
    })
    .catch(e => {
        err.textContent = `Could not apply moderation: ${e.message}`;
        toggle(err, true);
    });
}
</script>

{% endblock %}
